{% extends "base.html" %}

{% block title %}Backups - Smart Mower Control Panel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">
                <i class="bi bi-archive-fill me-2"></i>Configuration Backups
            </h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshBackups()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
                <button class="btn btn-success" onclick="createBackup()">
                    <i class="bi bi-plus-lg me-1"></i>Create Backup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Backup Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-archive text-primary" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Total Backups</h5>
                <h3 class="text-primary" id="total-backups">{{ backups | length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-clock-history text-info" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Latest Backup</h5>
                <h6 class="text-info" id="latest-backup">
                    {% if backups %}
                        {{ backups[0].created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        None
                    {% endif %}
                </h6>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-hdd text-success" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Total Size</h5>
                <h6 class="text-success" id="total-size">
                    {% set total_size = backups | sum(attribute='size') %}
                    {% if total_size > 1024*1024 %}
                        {{ "%.1f MB" | format(total_size / (1024*1024)) }}
                    {% elif total_size > 1024 %}
                        {{ "%.1f KB" | format(total_size / 1024) }}
                    {% else %}
                        {{ total_size }} B
                    {% endif %}
                </h6>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-shield-check text-warning" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Auto Backup</h5>
                <h6 class="text-warning">Enabled</h6>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning-charge me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-success btn-lg w-100" onclick="createBackup()">
                            <i class="bi bi-plus-circle d-block mb-2" style="font-size: 2rem;"></i>
                            Create Manual Backup
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-primary btn-lg w-100" onclick="uploadBackup()">
                            <i class="bi bi-upload d-block mb-2" style="font-size: 2rem;"></i>
                            Upload Backup
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-info btn-lg w-100" onclick="downloadCurrentConfig()">
                            <i class="bi bi-download d-block mb-2" style="font-size: 2rem;"></i>
                            Download Current
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-warning btn-lg w-100" onclick="cleanupOldBackups()">
                            <i class="bi bi-trash d-block mb-2" style="font-size: 2rem;"></i>
                            Cleanup Old
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backup List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Available Backups
                </h5>
            </div>
            <div class="card-body">
                {% if backups %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-calendar3 me-1"></i>Created</th>
                                <th><i class="bi bi-tag me-1"></i>Name</th>
                                <th><i class="bi bi-file-text me-1"></i>Description</th>
                                <th><i class="bi bi-hdd me-1"></i>Size</th>
                                <th><i class="bi bi-gear me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for backup in backups %}
                            <tr>
                                <td>
                                    <span class="fw-bold">{{ backup.created_at.strftime('%Y-%m-%d') }}</span><br>
                                    <small class="text-muted">{{ backup.created_at.strftime('%H:%M:%S') }}</small>
                                </td>
                                <td>
                                    <span class="fw-bold">{{ backup.name }}</span><br>
                                    <small class="text-muted">{{ backup.filename }}</small>
                                </td>
                                <td>
                                    {{ backup.description or 'No description' }}<br>
                                    {% if backup.auto_created %}
                                    <small class="badge bg-info">Auto-created</small>
                                    {% else %}
                                    <small class="badge bg-success">Manual</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if backup.size > 1024*1024 %}
                                        {{ "%.1f MB" | format(backup.size / (1024*1024)) }}
                                    {% elif backup.size > 1024 %}
                                        {{ "%.1f KB" | format(backup.size / 1024) }}
                                    {% else %}
                                        {{ backup.size }} B
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="restoreBackup('{{ backup.filename }}')"
                                                title="Restore this backup">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="downloadBackup('{{ backup.filename }}')"
                                                title="Download backup">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="previewBackup('{{ backup.filename }}')"
                                                title="Preview backup">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteBackup('{{ backup.filename }}')"
                                                title="Delete backup">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-archive text-muted" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3">No Backups Available</h4>
                    <p class="text-muted">Create your first backup to get started.</p>
                    <button class="btn btn-primary" onclick="createBackup()">
                        <i class="bi bi-plus-lg me-1"></i>Create First Backup
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Configuration Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createBackupForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="backupName" class="form-label">Backup Name</label>
                        <input type="text" class="form-control" id="backupName" 
                               placeholder="e.g., Before PID tuning" required>
                    </div>
                    <div class="mb-3">
                        <label for="backupDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="backupDescription" rows="3" 
                                  placeholder="Describe what changes you're about to make..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeSystemInfo" checked>
                        <label class="form-check-label" for="includeSystemInfo">
                            Include system information (recommended)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-1"></i>Create Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Backup Modal -->
<div class="modal fade" id="uploadBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Configuration Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadBackupForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="backupFile" class="form-label">Select Backup File</label>
                        <input type="file" class="form-control" id="backupFile" 
                               accept=".json,.bak" required>
                        <div class="form-text">
                            Supported formats: JSON configuration files (.json) or backup files (.bak)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="uploadName" class="form-label">Backup Name</label>
                        <input type="text" class="form-control" id="uploadName" 
                               placeholder="Name for this backup" required>
                    </div>
                    <div class="mb-3">
                        <label for="uploadDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="uploadDescription" rows="2" 
                                  placeholder="Description of this backup..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-1"></i>Upload Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Backup Modal -->
<div class="modal fade" id="previewBackupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewBackupModalLabel">Backup Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="backupPreviewContent" class="bg-dark text-light p-3" 
                     style="height: 500px; overflow-y: auto; font-size: 0.875rem;">
Loading backup content...
                </pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="restoreFromPreview">
                    <i class="bi bi-arrow-clockwise me-1"></i>Restore This Backup
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPreviewBackup = '';

function refreshBackups() {
    location.reload();
}

function createBackup() {
    const modal = new bootstrap.Modal(document.getElementById('createBackupModal'));
    modal.show();
}

function uploadBackup() {
    const modal = new bootstrap.Modal(document.getElementById('uploadBackupModal'));
    modal.show();
}

function downloadCurrentConfig() {
    fetch('/api/config')
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'robot_config_current_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('Error downloading current configuration: ' + error);
        });
}

function cleanupOldBackups() {
    if (confirm('This will delete backups older than 30 days. Are you sure?')) {
        fetch('/backups/cleanup', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Cleaned up ${data.deleted_count} old backups.`);
                    location.reload();
                } else {
                    alert('Error cleaning up backups: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error cleaning up backups: ' + error);
            });
    }
}

function restoreBackup(filename) {
    if (confirm(`Are you sure you want to restore the backup "${filename}"? This will replace the current configuration and restart all services.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/backups/restore/${filename}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function downloadBackup(filename) {
    window.location.href = `/backups/download/${filename}`;
}

function previewBackup(filename) {
    currentPreviewBackup = filename;
    document.getElementById('previewBackupModalLabel').textContent = `Preview: ${filename}`;
    
    const modal = new bootstrap.Modal(document.getElementById('previewBackupModal'));
    modal.show();
    
    const content = document.getElementById('backupPreviewContent');
    content.textContent = 'Loading backup content...';
    
    fetch(`/api/backups/${filename}/preview`)
        .then(response => response.json())
        .then(data => {
            content.textContent = JSON.stringify(data, null, 2);
        })
        .catch(error => {
            content.textContent = 'Error loading backup: ' + error;
        });
}

function deleteBackup(filename) {
    if (confirm(`Are you sure you want to delete the backup "${filename}"? This action cannot be undone.`)) {
        fetch(`/backups/delete/${filename}`, {method: 'DELETE'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting backup: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error deleting backup: ' + error);
            });
    }
}

// Handle create backup form
document.getElementById('createBackupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('backupName').value,
        description: document.getElementById('backupDescription').value,
        include_system_info: document.getElementById('includeSystemInfo').checked
    };
    
    fetch('/backups/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createBackupModal')).hide();
            location.reload();
        } else {
            alert('Error creating backup: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error creating backup: ' + error);
    });
});

// Handle upload backup form
document.getElementById('uploadBackupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('file', document.getElementById('backupFile').files[0]);
    formData.append('name', document.getElementById('uploadName').value);
    formData.append('description', document.getElementById('uploadDescription').value);
    
    fetch('/backups/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('uploadBackupModal')).hide();
            location.reload();
        } else {
            alert('Error uploading backup: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error uploading backup: ' + error);
    });
});

// Handle restore from preview
document.getElementById('restoreFromPreview').addEventListener('click', function() {
    if (currentPreviewBackup) {
        bootstrap.Modal.getInstance(document.getElementById('previewBackupModal')).hide();
        restoreBackup(currentPreviewBackup);
    }
});

// Auto-generate backup name based on current date
document.getElementById('createBackupModal').addEventListener('shown.bs.modal', function() {
    const now = new Date();
    const defaultName = `Backup ${now.toISOString().slice(0,16).replace('T', ' ')}`;
    document.getElementById('backupName').value = defaultName;
});

// Auto-generate upload name based on file name
document.getElementById('backupFile').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const name = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
        document.getElementById('uploadName').value = name;
    }
});
</script>
{% endblock %}
