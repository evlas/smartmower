{% extends "base.html" %}

{% block title %}Dashboard - Smart Mower Control Panel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">
                <i class="bi bi-speedometer2 me-2"></i>System Dashboard
            </h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshStatus()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
                <a href="{{ url_for('config_view') }}" class="btn btn-primary">
                    <i class="bi bi-sliders me-1"></i>Configure
                </a>
            </div>
        </div>
    </div>
</div>

<!-- System Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-cpu-fill text-primary" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Services</h5>
                <h3 class="text-primary" id="services-count">
                    {{ services_status.values() | selectattr("equalto", "active") | list | length }}/{{ services_status | length }}
                </h3>
                <small class="text-muted">Active Services</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-gear-fill text-success" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Configuration</h5>
                <h3 class="text-success">OK</h3>
                <small class="text-muted">System Config</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-shield-check text-info" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Security</h5>
                <h3 class="text-info">Secure</h3>
                <small class="text-muted">System Status</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-clock-fill text-warning" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Uptime</h5>
                <h3 class="text-warning" id="system-uptime">--:--</h3>
                <small class="text-muted">System Uptime</small>
            </div>
        </div>
    </div>
</div>

<!-- Services Status -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check me-2"></i>Services Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for service, status in services_status.items() %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card service-card service-{{ status }}">
                            <div class="card-body py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title mb-1">
                                            {% if 'pico' in service %}
                                                <i class="bi bi-cpu me-1"></i>Pico Bridge
                                            {% elif 'gps' in service %}
                                                <i class="bi bi-geo-alt me-1"></i>GPS Bridge
                                            {% elif 'fusion' in service %}
                                                <i class="bi bi-diagram-3 me-1"></i>Sensor Fusion
                                            {% elif 'path-planning' in service %}
                                                <i class="bi bi-map me-1"></i>Path Planning
                                            {% elif 'slam' in service %}
                                                <i class="bi bi-compass me-1"></i>SLAM
                                            {% elif 'state-machine' in service %}
                                                <i class="bi bi-gear-wide-connected me-1"></i>State Machine
                                            {% elif 'vision-camera' in service %}
                                                <i class="bi bi-camera me-1"></i>Vision Camera
                                            {% elif 'vision-grass' in service %}
                                                <i class="bi bi-flower1 me-1"></i>Grass Detection
                                            {% elif 'vision-obstacle' in service %}
                                                <i class="bi bi-exclamation-triangle me-1"></i>Obstacle Detection
                                            {% elif 'vision-perimeter' in service %}
                                                <i class="bi bi-bounding-box me-1"></i>Perimeter Detection
                                            {% else %}
                                                <i class="bi bi-gear me-1"></i>{{ service.replace('smartmower-', '').replace('-', ' ').title() }}
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ service }}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="status-{{ status }}" id="status-{{ service }}">
                                            {{ status.upper() }}
                                        </span>
                                        <br>
                                        <button class="btn btn-sm btn-outline-primary mt-1" 
                                                onclick="restartService('{{ service }}')">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-success btn-lg" onclick="restartAllServices()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Restart All Services
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning-charge me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('config_view') }}" class="btn btn-outline-primary btn-lg w-100">
                            <i class="bi bi-sliders d-block mb-2" style="font-size: 2rem;"></i>
                            Edit Configuration
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('services_view') }}" class="btn btn-outline-success btn-lg w-100">
                            <i class="bi bi-cpu-fill d-block mb-2" style="font-size: 2rem;"></i>
                            Manage Services
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('backups_view') }}" class="btn btn-outline-info btn-lg w-100">
                            <i class="bi bi-archive-fill d-block mb-2" style="font-size: 2rem;"></i>
                            View Backups
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-warning btn-lg w-100" onclick="downloadConfig()">
                            <i class="bi bi-download d-block mb-2" style="font-size: 2rem;"></i>
                            Download Config
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>System Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Configuration File:</strong></td>
                                <td>/opt/smartmower/etc/robot_config.json</td>
                            </tr>
                            <tr>
                                <td><strong>Log Directory:</strong></td>
                                <td>/opt/smartmower/log/</td>
                            </tr>
                            <tr>
                                <td><strong>Data Directory:</strong></td>
                                <td>/opt/smartmower/data/</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>System User:</strong></td>
                                <td>smartmower</td>
                            </tr>
                            <tr>
                                <td><strong>Web Interface:</strong></td>
                                <td>Port 8080</td>
                            </tr>
                            <tr>
                                <td><strong>Version:</strong></td>
                                <td>1.0.0</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshStatus() {
    location.reload();
}

function restartService(serviceName) {
    if (confirm(`Are you sure you want to restart ${serviceName}?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/services/restart/${serviceName}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function restartAllServices() {
    if (confirm('Are you sure you want to restart ALL services? This will temporarily interrupt robot operations.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/services/restart-all';
        document.body.appendChild(form);
        form.submit();
    }
}

function downloadConfig() {
    fetch('/api/config')
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'robot_config_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('Error downloading configuration: ' + error);
        });
}

// Get system uptime
function updateUptime() {
    fetch('/proc/uptime')
        .then(response => response.text())
        .then(data => {
            const uptime = parseFloat(data.split(' ')[0]);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            document.getElementById('system-uptime').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
        })
        .catch(error => {
            document.getElementById('system-uptime').textContent = 'N/A';
        });
}

// Update uptime every minute
setInterval(updateUptime, 60000);
updateUptime();
</script>
{% endblock %}
